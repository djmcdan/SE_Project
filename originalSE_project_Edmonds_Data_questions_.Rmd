---

title: "SE project Edmonds Data exploration and question"
author: "Darius McDaniel"
date: "November 20, 2015"
output: word_document
---

----------

## This document will aim to answer different questions from the edmonds data. There will be a question answered for most of the main topics covered in this semesters class.

All programs will be added and committed to github and found here : https://github.com/djmcdan/SE_Project.git

Below are all the packages used in this project and also the data used.


```{r, echo=FALSE, message=F, warning=F}

#SE_projectPackages

suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(bit64))
suppressPackageStartupMessages(library(plyr))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(sqldf))
suppressPackageStartupMessages(library(tcltk))
suppressPackageStartupMessages(library(RSQLite))
suppressPackageStartupMessages(library(DescTools))
suppressPackageStartupMessages(library(lubridate))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(googleVis))
suppressPackageStartupMessages(library(lattice))
suppressPackageStartupMessages(library(ggmap))
suppressPackageStartupMessages(library(zipcode))

```

```{r, echo=FALSE, message=F, warning=F}
setwd("C:/Users/Darius/Documents/DF2015_Data/DF2015_revised") 

#SE_projectData
visitor <- fread("visitor.csv",stringsAsFactors=FALSE)
transactions <- fread("transactions.csv",stringsAsFactors=FALSE)
shopping <- fread("shopping.csv",stringsAsFactors=FALSE)
leads <- fread("leads.csv",stringsAsFactors=FALSE)
configuration <- fread("configuration.csv",stringsAsFactors=FALSE)


```

Now we start with questions for exploration in 5 topics discussed this semester around using Dyplyr, Visualizations, sqldf, objects and JSON/XML to answer different questions with the Edmonds car data. 

Questions

    1. Dplyr. 
        
    Based on the visitor data how long did the visits last and did the longer visit times lead to purchases or vis versa?
    
       

To first answer this question we must do some data cleaning. 

```{r, echo=FALSE, message=F, warning=F}



#Question a.
visitor_time <- visitor %>% 
  mutate(new_dwell_time_mins = new_dwell_time/60, used_dwell_time_mins = used_dwell_time/60 , tot_dwell_time_mins =   tot_dwell_time/60 , tot_dwell_time_hours = tot_dwell_time_mins/60)%>% 
  select(visitor_key, tot_dwell_time, tot_dwell_time_mins,tot_dwell_time_hours, zip)


sum_visitor_time <- visitor_time %>% group_by(visitor_key)%>% summarise(hours_sum_time = sum(tot_dwell_time_hours, na.rm = TRUE))


mean_med_visitor_time <-sum_visitor_time %>% summarise(mean_hours_visited = mean(hours_sum_time , na.rm = TRUE),median_hours_visited = median(hours_sum_time , na.rm = TRUE))

#Question b.



new_bought <- transactions  %>% filter(new_or_used_bought == "N") %>% select(visitor_key, date_sold, new_or_used_bought, price_bought,model_bought,make_bought,model_year_bought,mileage_bought,bodytype_bought,zip_bought)%>% distinct()
used_bought <- transactions %>% filter(new_or_used_bought == "U") %>% select(visitor_key, date_sold, new_or_used_bought, price_bought,model_bought,make_bought,model_year_bought,mileage_bought,bodytype_bought,zip_bought)%>% distinct()



visitor_purchased_new <- sum_visitor_time %>%inner_join(new_bought)%>% distinct()
visitor_purchased_used <- sum_visitor_time %>%inner_join(used_bought)%>% distinct()

avgs_visitor_time_purchaseNw <-visitor_purchased_new %>% summarise(min_hours_visited = min(hours_sum_time , na.rm = TRUE), mean_hours_visited = mean(hours_sum_time , na.rm = TRUE),med_hours_visited = median(hours_sum_time , na.rm = TRUE), max_hours_visited = max(hours_sum_time , na.rm = TRUE))
avgs_visitor_time_purchaseUs <-visitor_purchased_used %>% summarise(min_hours_visited = min(hours_sum_time , na.rm = TRUE), mean_hours_visited = mean(hours_sum_time , na.rm = TRUE),med_hours_visited = median(hours_sum_time , na.rm = TRUE), max_hours_visited = max(hours_sum_time , na.rm = TRUE))



#Question c.

new_bought_cat <- visitor_purchased_new %>% mutate(time_hours_cat = ifelse(hours_sum_time < 1, 1, ifelse(hours_sum_time >= 1 & hours_sum_time < 5,2,
                                                                                                               ifelse(hours_sum_time >= 5 & hours_sum_time < 10,3,   
                                                                                                                      ifelse(hours_sum_time >= 10 & hours_sum_time < 20,4,
                                                                                                                             ifelse(hours_sum_time >= 20 & hours_sum_time < 48,5,
                                                                                                                                    ifelse(hours_sum_time >= 48 & hours_sum_time < 72,6,
                                                                                                                                           ifelse(hours_sum_time >72,7,NA)))))))) 
new_bought_cat$time_hours_cat<- factor(new_bought_cat$time_hours_cat, levels = c(1,2,3,4,5,6,7), labels = c(">1hr", " 1-5hrs", " 5-10hrs","10-20hrs","20-48hrs", "48-72hrs", ">72hrs")) 



used_bought_cat <- visitor_purchased_used %>% mutate(time_hours_cat = ifelse(hours_sum_time < 1, 1, ifelse(hours_sum_time >= 1 & hours_sum_time < 5,2,
                                                                                                                 ifelse(hours_sum_time >= 5 & hours_sum_time < 10,3,   
                                                                                                                        ifelse(hours_sum_time >= 10 & hours_sum_time < 20,4,
                                                                                                                               ifelse(hours_sum_time >= 20 & hours_sum_time < 48,5,
                                                                                                                                      ifelse(hours_sum_time >= 48 & hours_sum_time < 72,6,
                                                                                                                                             ifelse(hours_sum_time >72,7,NA)))))))) 


used_bought_cat$time_hours_cat<- factor(used_bought_cat$time_hours_cat, levels = c(1,2,3,4,5,6,7), labels = c(">1hr", " 1-5hrs", " 5-10hrs","10-20hrs","20-48hrs", "48-72hrs", ">72hrs")) 

#Question d.


milage_bought_new <- new_bought_cat %>% mutate(mileage_cat100 <-ifelse(mileage_bought <= 100, 1, ifelse(mileage_bought > 100,2,0))) 

milage_bought_new$year_purchased <- as.numeric( format( as.Date( milage_bought_new$date_sold, origin='1900-1-1'), '%Y'))

milage_bought_used <- used_bought_cat %>% mutate(mileage_cat100 <-ifelse(mileage_bought <= 100, 1, ifelse(mileage_bought > 100,2,0))) 

 milage_bought_used$year_purchased <- as.numeric( format( as.Date( milage_bought_used$date_sold, origin='1900-1-1'), '%Y'))

```
Answers to posed questions

```{r}
#a. What was the average,min and max time spent on the site for all visits
mean_med_visitor_time


#b. Now for those that purchased new or used car what was the avg time visited?

avgs_visitor_time_purchaseNw
avgs_visitor_time_purchaseUs



#c. How many purchases were  >1hr, 1-5, 5-10,10-20, gt20 hrs


table(new_bought_cat$time_hours_cat )
table(used_bought_cat$time_hours_cat )

histogram(new_bought_cat$time_hours_cat)
histogram(used_bought_cat$time_hours_cat)

#Observation Over 50percent of purchases that happened within an hour of visiting the site for new and used cars

#d. How many new cars had less than 100 miles on them and greater than 100 miles?

#New
  table(milage_bought_new$mileage_cat100 )

#Used 
  table(milage_bought_used$mileage_cat100 )




```       
        

    2. Visualizations ( googlevis, ggplot2,  fusion tables)
        
       Using zip codes provided from transactions map the US top five models bought? Look at this per year bought?
       Compare the graphs for the visits less than an hour that purchased cars to the 1-5hr visits?
       Are there differences?
```{r, echo=FALSE, message=F, warning=F}
 
zipcode_tran <- transactions %>% mutate(zip = zip_bought) %>% select(zip) %>% distinct()
data(zipcode)

milage_bought_new <- milage_bought_new %>% mutate(zip = as.factor(zip_bought))
milage_bought_used <- milage_bought_used %>% mutate(zip = as.factor(zip_bought))

  
new_bought_latlon = merge(milage_bought_new,zipcode, by.x='zip', by.y='zip') 
use_bought_latlon = merge(milage_bought_used,zipcode, by.x='zip', by.y='zip') 



#Googlevis

#Paste the lat and long together for googlevis
new_bought_latlon$LatLon <- paste(round(new_bought_latlon$latitude,2),round(new_bought_latlon$longitude,2),sep=":")
use_bought_latlon$LatLon <- paste(round(use_bought_latlon$latitude,2),round(use_bought_latlon$longitude,2),sep=":")

#Remove any NAs in both
new_bought_latlon_ <- new_bought_latlon[new_bought_latlon$LatLon != "NA:NA",] 
use_bought_latlon_ <- use_bought_latlon[use_bought_latlon$LatLon != "NA:NA",]

#Plot
new_bought_latlon_.plot <- gvisMap(new_bought_latlon_, "LatLon" ,
                                   options=list( showLine=TRUE, enableScrollWheel=TRUE,
                                                 mapType='hybrid', useMapTypeControl=TRUE,
                                                 width=1500,height=800))



use_bought_latlon_.plot <- gvisMap(use_bought_latlon_, "LatLon" ,
              options=list( showLine=TRUE, enableScrollWheel=TRUE,
                           mapType='hybrid', useMapTypeControl=TRUE,
                           width=1500,height=800))


plot(new_bought_latlon_.plot)
plot(use_bought_latlon_.plot)


#Now will use ggmap and ggplot  see if this is better

statecount_nbll <- new_bought_latlon_ %>% group_by(state,year_purchased) %>% summarise(n = n ()) %>% mutate(ct = n/100)
statecount_ubll <- use_bought_latlon_ %>% group_by(state,year_purchased) %>% summarise(n = n ()) %>% mutate(ct = n/100)




p_n = qmplot(longitude, latitude, data = new_bought_latlon_, colour = I("blue"),size = I(3), darken = .3) + facet_wrap(~ year_purchased) +  expand_limits() + theme_minimal() + labs(title = "Map of New purchased cars in US from 2013 - 2015")  
p_u = qmplot(longitude, latitude, data = new_bought_latlon_, colour = I("blue"),size = I(3), darken = .3) + facet_wrap(~ year_purchased) +  expand_limits() + theme_minimal() + labs(title = "Map of Used purchased cars in US from 2013 - 2015")  


plot(p_n)
plot(p_u)

statecount_nbll$region_ <- state.name[match(statecount_nbll$state,state.abb)]
statecount_nbll$region <- tolower(statecount_nbll$region_)

statecount_ubll$region_ <- state.name[match(statecount_ubll$state,state.abb)]
statecount_ubll$region <- tolower(statecount_ubll$region_)

#Map of new cars purchased in the US from 2013-2015

us <- map_data("state")

gg_nw <- ggplot() + geom_map(data=us, map=us,
                    aes(x=long, y=lat, map_id=region),
                    fill="#ffffff", color="#ffffff", size=0.15)
gg_nw <- gg_nw + geom_map(data=statecount_nbll, map=us,
                    aes(fill=n, map_id=region),
                    color="#ffffff", size=0.15) + facet_wrap(~ year_purchased) 
#Want to see them the maps horizontally and in new color

gg_nw <- gg_nw + scale_fill_continuous(low='thistle2', high='darkred', 
                                 guide='colorbar')+ facet_wrap(~ year_purchased, ncol = 1)  + labs(title = "Map of New purchased cars in US")  
gg_nw

#Want to make it look alittle better 
gg_nw <- gg_nw + labs(x=NULL, y=NULL) + coord_map("albers", lat0 = 39, lat1 = 45) + theme(panel.border = element_blank())  + theme(panel.background = element_blank()) + theme(axis.ticks = element_blank()) + theme(axis.text = element_blank())
gg_nw

##Map of used cars purchased in the US from 2013-2015
gg_us <- ggplot() + geom_map(data=us, map=us,
                          aes(x=long, y=lat, map_id=region),
                          fill="#ffffff", color="#ffffff", size=0.15)
gg_us <- gg_us + geom_map(data=statecount_ubll, map=us,
                          aes(fill=n, map_id=region),
                          color="#ffffff", size=0.15) + facet_wrap(~ year_purchased) 

#Want to see them the maps horizontally and in new color

gg_us <- gg_us + scale_fill_continuous(low='thistle2', high='darkred', 
                                       guide='colorbar')+ facet_wrap(~ year_purchased, ncol = 1) + labs(title = "Map of Used purchased cars in US")  

gg_us

#Want to make it look alittle better 

gg_us <- gg_us + labs(x=NULL, y=NULL) + coord_map("albers", lat0 = 39, lat1 = 45) + theme(panel.border = element_blank())  + theme(panel.background = element_blank()) + theme(axis.ticks = element_blank()) + theme(axis.text = element_blank())
gg_us
 
 
 
```   
 
  c. SQL (sqldf / Rsqlite)
    

        Create a SQLite database and figure out : How many new cars where bought by manufactuer year ?, How many different body types were           purchased new and used displaying only the top 10 ?,  What are the top five makers that sold the most new and used cars?,
        What are the average, min and max mileages bought along with the average, min and max price bought?


```{r, echo=FALSE, message=F, warning=F}    
#Create the SQLite data base
  
db <- dbConnect(SQLite(), dbname="Edmonds.sqlite")

setwd("C:/Users/Darius/Documents/DF2015_Data/DF2015_revised") 

#Below write the different dataset into sql tables

dbWriteTable(conn = db, name = "Visitor_", value = "visitor.csv",
             row.names = FALSE, header = TRUE)
dbWriteTable(conn = db, name = "Transactions_", value = "transactions.csv",
             row.names = FALSE, header = TRUE)
dbWriteTable(conn = db, name = "Configuration_", value = "configuration.csv",
             row.names = FALSE, header = TRUE)
dbWriteTable(conn = db, name = "Leads_", value = "leads.csv",
             row.names = FALSE, header = TRUE)
dbWriteTable(conn = db, name = "Shopping_", value = "shopping.csv",
             row.names = FALSE, header = TRUE)


# The tables in the database
dbListTables(db)     

# The columns in Visitor and Transactions
dbListFields(db, "Visitor_")         
dbListFields(db, "Transactions_")  
```

Queries for Questions in the database

```{r}
      
#Lets see how many new cars where bought by manufactuer year

dbGetQuery(db,"SELECT model_year_bought as Model_year_purchased_New, count(*) as modelYR_freq from Transactions_  WHERE new_or_used_bought = 'N' GROUP BY model_year_bought")

dbGetQuery(db,"SELECT model_year_bought as Model_year_purchased_Used, count(*) as modelYR_freq from Transactions_  WHERE new_or_used_bought = 'U' GROUP BY model_year_bought")


#How many different body types were purchased new and used displaying only the top 10

dbGetQuery(db,"select bodytype_bought, count(*) as freq from Transactions_ WHERE new_or_used_bought = 'N' group by bodytype_bought order by freq desc LIMIT 10")
dbGetQuery(db,"select bodytype_bought, count(*) as freq from Transactions_ WHERE new_or_used_bought = 'U' group by bodytype_bought order by freq desc LIMIT 10")


#What are the top five makers that sold the most new and used cars 

dbGetQuery(db,"select make_bought, count(*) as freq from Transactions_ WHERE new_or_used_bought = 'N'  GROUP BY make_bought  order by freq desc LIMIT 5")

dbGetQuery(db,"select make_bought, count(*) as freq from Transactions_ WHERE new_or_used_bought = 'U' GROUP BY make_bought order by freq desc LIMIT 5")

#Honda and Toyota both have the most purchases for new and used


#What was the average, min and max mileages bought along with the average, min and max price bought for the top ten

#New
dbGetQuery(db,"select make_bought, count(*) as freq, min(price_bought), avg(price_bought), max(price_bought),min(mileage_bought),  avg(mileage_bought), max(mileage_bought)  
      from Transactions_ WHERE new_or_used_bought = 'N'  GROUP BY make_bought order by freq desc LIMIT 10")
#Used
dbGetQuery(db,"select make_bought, count(*) as freq, min(price_bought), avg(price_bought), max(price_bought),min(mileage_bought),  avg(mileage_bought), max(mileage_bought)  
      from Transactions_ WHERE new_or_used_bought = 'U'  GROUP BY make_bought order by freq desc LIMIT 10")



#Honda and Toyota both have the most purchases for new and used


```        

   d. Objects
    

    Create prints for the top vehicles purchased for the US with the average site visited time, create a print broken down by state.

    Summarize the total purchase amounts for the top models in each state.
    Plot the top makes purchased by zipcode. This will be plotted two ways using googlevis and  ggplot. 
    
    
    JSON/XML
    
     e.   Create a data frame based on top models bought in each year and pull important consummer rating data?
